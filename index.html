<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Управление оффлайн-заведениями</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
    }
    .form-section, .dashboard { 
      margin-bottom: 30px; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 20px;
    }
    th, td { 
      border: 1px solid #ccc; 
      padding: 10px; 
      text-align: center; 
    }
    th { 
      background-color: #f2f2f2; 
    }
    button { 
      cursor: pointer; 
    }
    select, input { 
      padding: 5px; 
      margin: 5px 0;
    }
  </style>
  
  <!-- Подключаем Firebase SDK (compat-версии для простоты) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Управление оффлайн-заведениями</h1>
  
  <!-- Форма для добавления заведения -->
  <div class="form-section">
    <h2>Добавить заведение</h2>
    <form id="addEstablishmentForm">
      <label>
        Имя заведения: <input type="text" id="name" required>
      </label><br><br>
      <label>
        Ссылка: <input type="url" id="url" required>
      </label><br><br>
      <label>
        Время оффлайн (в минутах): <input type="number" id="offlineTime" required>
      </label><br><br>
      <label>
        Причина перевода в оффлайн:<br>
        <select id="reason" required>
          <option value="" disabled selected>Выберите причину</option>
          <option value="Integration issues / Tech issues">Integration issues / Tech issues</option>
          <option value="Venue sets itself online">Venue sets itself online</option>
        </select>
      </label><br><br>
      <button type="submit">Добавить заведение</button>
    </form>
  </div>
  
  <!-- Дэшбоард с двумя разделами: Активные и История -->
  <div class="dashboard">
    <h2>Активные заведения</h2>
    <table id="activeTable">
      <thead>
        <tr>
          <th>Имя заведения</th>
          <th>Причина</th>
          <th>Ссылка</th>
          <th>Оставшееся время</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <!-- Активные заведения подставляются динамически -->
      </tbody>
    </table>
    
    <h2>История (Истекшие заведения)</h2>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Имя заведения</th>
          <th>Причина</th>
          <th>Ссылка</th>
          <th>Оффлайн до</th>
        </tr>
      </thead>
      <tbody>
        <!-- История подставляется динамически -->
      </tbody>
    </table>
  </div>
  
  <script>
    // ===================== 1. ИНИЦИАЛИЗАЦИЯ FIREBASE =====================
    // Ваши данные из Firebase Console:
    const firebaseConfig = {
      apiKey: "AIzaSyBaQYzQmld5VNA_wSI8nDtqENN0TgcNqeA",
      authDomain: "adminsonly.firebaseapp.com",
      databaseURL: "https://adminsonly-default-rtdb.firebaseio.com",
      projectId: "adminsonly",
      storageBucket: "adminsonly.firebasestorage.app",
      messagingSenderId: "194528429901",
      appId: "1:194528429901:web:805ca2f1dd0feca2de1904"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===================== 2. SLACK WEBHOOK =====================
    const slackWebhookURL = "https://hooks.slack.com/triggers/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";
    function sendWebhook(text) {
      fetch(slackWebhookURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: text })
      })
      .then(() => console.log("Вебхук отправлен."))
      .catch(err => console.error("Ошибка вебхука:", err));
    }

    // ===================== 3. ДОБАВЛЕНИЕ ЗАВЕДЕНИЯ =====================
    function addEstablishment(establishment) {
      const newRef = db.ref("establishments").push();
      establishment.id = newRef.key;
      newRef.set(establishment, error => {
        if (!error) {
          const text = `Добавлено заведение: ${establishment.name}.
Ссылка: ${establishment.url}.
Оффлайн до: ${new Date(establishment.offlineUntil).toLocaleString()}.
Причина: ${establishment.reason}`;
          sendWebhook(text);
        } else {
          console.error("Ошибка сохранения:", error);
        }
      });
    }

    // ===================== 4. ПОДПИСКА НА ИЗМЕНЕНИЯ (ОБЩАЯ ФУНКЦИЯ) =====================
    function subscribeToDashboard() {
      db.ref("establishments").on("value", snapshot => {
        const data = snapshot.val();
        const allEstablishments = data ? Object.values(data) : [];
        renderDashboards(allEstablishments);
      });
    }

    // ===================== 5. ОТРИСОВКА ДЭШБОАРДА =====================
    function renderDashboards(establishments) {
      const activeTbody = document.getElementById("activeTable").querySelector("tbody");
      const historyTbody = document.getElementById("historyTable").querySelector("tbody");
      activeTbody.innerHTML = "";
      historyTbody.innerHTML = "";
      
      establishments.forEach(est => {
        if (est.expired) {
          // Рисуем строку для истории
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = est.name;
          tr.appendChild(tdName);

          const tdReason = document.createElement("td");
          tdReason.textContent = est.reason || "";
          tr.appendChild(tdReason);

          const tdUrl = document.createElement("td");
          const link = document.createElement("a");
          link.href = est.url;
          link.target = "_blank";
          link.textContent = "Ссылка";
          tdUrl.appendChild(link);
          tr.appendChild(tdUrl);

          const tdOfflineUntil = document.createElement("td");
          tdOfflineUntil.textContent = new Date(est.offlineUntil).toLocaleString();
          tr.appendChild(tdOfflineUntil);

          historyTbody.appendChild(tr);
        } else {
          // Рисуем строку для активных заведений
          const tr = document.createElement("tr");
          
          const tdName = document.createElement("td");
          tdName.textContent = est.name;
          tr.appendChild(tdName);

          const tdReason = document.createElement("td");
          tdReason.textContent = est.reason || "";
          tr.appendChild(tdReason);

          const tdUrl = document.createElement("td");
          const link = document.createElement("a");
          link.href = est.url;
          link.target = "_blank";
          link.textContent = "Ссылка";
          tdUrl.appendChild(link);
          tr.appendChild(tdUrl);
          
          const tdTimer = document.createElement("td");
          tdTimer.id = "timer-" + est.id;
          tr.appendChild(tdTimer);
          
          const tdAction = document.createElement("td");
          const addTimeBtn = document.createElement("button");
          addTimeBtn.textContent = "Добавить время";
          addTimeBtn.addEventListener("click", function() {
            addExtraTime(est.id);
          });
          tdAction.appendChild(addTimeBtn);
          tr.appendChild(tdAction);
          
          activeTbody.appendChild(tr);
        }
      });
    }

    // ===================== 6. ОБНОВЛЕНИЕ ТАЙМЕРОВ =====================
    function updateTimers() {
      db.ref("establishments").once("value", snapshot => {
        const data = snapshot.val();
        if (data) {
          Object.values(data).forEach(est => {
            if (!est.expired) {
              const timerTd = document.getElementById("timer-" + est.id);
              if (timerTd) {
                const now = new Date();
                const offlineUntil = new Date(est.offlineUntil);
                const remainingMs = offlineUntil - now;
                if (remainingMs > 0) {
                  const minutes = Math.floor(remainingMs / 60000);
                  const seconds = Math.floor((remainingMs % 60000) / 1000);
                  timerTd.textContent = `${minutes} мин ${seconds} сек`;
                } else {
                  timerTd.textContent = "Время истекло";
                  // Если время истекло – переводим заведение в историю (устанавливаем expired)
                  db.ref("establishments/" + est.id).update({ expired: true }, error => {
                    if (!error) {
                      const text = `Оффлайн время истекло для заведения: ${est.name}.
(${est.url})
Причина: ${est.reason}`;
                      sendWebhook(text);
                    }
                  });
                }
              }
            }
          });
        }
      });
    }

    // ===================== 7. ДОБАВЛЕНИЕ ДОПОЛНИТЕЛЬНОГО ВРЕМЕНИ =====================
    function addExtraTime(id) {
      const additionalTime = prompt("Введите дополнительное время в минутах:");
      if (!additionalTime) return;
      const additionalMs = parseInt(additionalTime, 10) * 60 * 1000;
      const ref = db.ref("establishments/" + id);
      ref.once("value", snapshot => {
        const est = snapshot.val();
        if (est) {
          const newOfflineUntil = new Date(new Date(est.offlineUntil).getTime() + additionalMs);
          // Обновляем время и снимаем флаг expired, чтобы заведение вернулось в активные
          ref.update({ offlineUntil: newOfflineUntil, expired: false }, error => {
            if (!error) {
              const text = `Для заведения ${est.name} добавлено дополнительное время (${additionalTime} мин).
Новый оффлайн до: ${newOfflineUntil.toLocaleString()}.
Причина: ${est.reason}`;
              sendWebhook(text);
            }
          });
        }
      });
    }

    // ===================== 8. ИНИЦИАЛИЗАЦИЯ =====================
    window.addEventListener("load", () => {
      subscribeToDashboard();
      setInterval(updateTimers, 1000);
    });

    // ===================== 9. ОБРАБОТКА ФОРМЫ =====================
    document.getElementById("addEstablishmentForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const url = document.getElementById("url").value;
      const offlineTimeMinutes = parseInt(document.getElementById("offlineTime").value, 10);
      const reason = document.getElementById("reason").value;  // Получаем выбранную причину
      const now = new Date();
      const offlineUntil = new Date(now.getTime() + offlineTimeMinutes * 60 * 1000);
      
      const establishment = {
        name: name,
        url: url,
        offlineUntil: offlineUntil.toISOString(),
        addedOfflineTime: offlineTimeMinutes,
        reason: reason,
        expired: false
      };
      
      addEstablishment(establishment);
      e.target.reset();
    });
  </script>
</body>
</html>
